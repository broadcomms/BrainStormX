<!-- app/account/templates/account_details.html -->
{% extends "main_template.html" %}
{% block title %}Account{% endblock %}

{% block content %}
<section class="py-4 bg-body-tertiary">
  <div class="container">
    <!-- Page header -->
    <div class="d-flex flex-wrap align-items-center justify-content-between mb-3">
      <div class="me-2">
        <h1 class="h4 fw-bold mb-1 d-flex align-items-center gap-2">
          <i class="bi bi-person-circle"></i>
          <span>Account</span>
        </h1>
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb mb-0 small">
            <li class="breadcrumb-item"><a href="{{ url_for('main_bp.index') }}">Home</a></li>
            <li class="breadcrumb-item active" aria-current="page">Account</li>
          </ol>
        </nav>
      </div>
      <div class="d-flex gap-2 mt-3 mt-sm-0">
        <a href="{{ url_for('account_bp.public_profile', user_id=user.user_id) }}" class="btn btn-outline-secondary">
          <i class="bi bi-person-badge me-1"></i>View Profile
        </a>
        <a href="{{ url_for('workspace_bp.create_workspace') }}" class="btn btn-primary">
          <i class="bi bi-building-add me-1"></i>New Workspace
        </a>
        <a href="{{ url_for('workshop_bp.create_workshop_general') }}" class="btn btn-outline-primary">
          <i class="bi bi-calendar-plus me-1"></i>New Workshop
        </a>
      </div>
    </div>

    <div class="row g-4">
      <!-- LEFT COLUMN: Profile & Quick nav -->
      <aside class="col-lg-4 col-xl-3">
        <div class="card shadow-sm border-0 mb-4">
          <div class="card-body text-center">
            <span class="avatar-circle d-inline-block overflow-hidden avatar-112">
              <img src="{{ profile_url(user.profile_pic_url) }}" alt="Profile picture of {{ display_name }}" class="avatar-img">
            </span>
            <h5 class="mb-0">Hello, {{ display_name }}!</h5>
            <small class="text-body-secondary d-block mb-2">{{ user.email }}</small>


            {% if user.organization or user.job_title %}
              <div class="d-flex flex-wrap justify-content-center gap-2 mb-3">
                {% if user.organization %}
                  <span class="badge text-bg-light"><i class="bi bi-building me-1"></i>{{ user.organization }}</span>
                {% endif %}
                {% if user.job_title %}
                  <span class="badge text-bg-light"><i class="bi bi-briefcase me-1"></i>{{ user.job_title }}</span>
                {% endif %}
              </div>
            {% endif %}

            <!-- Vertical actions -->
            <div class="d-grid gap-2">
              <a href="{{ url_for('account_bp.public_profile', user_id=user.user_id) }}" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-person-badge me-1"></i>View Profile
              </a>
              <a href="{{ url_for('account_bp.update_photo') }}" class="btn btn-outline-primary btn-sm">
                <i class="bi bi-camera me-1"></i>Update Photo
              </a>
              <a href="{{ url_for('account_bp.edit_account') }}" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-pencil-square me-1"></i>Edit Profile
              </a>
              <a href="{{ url_for('auth_bp.change_password') }}" class="btn btn-outline-warning btn-sm">
                <i class="bi bi-key me-1"></i>Change Password
              </a>
              <a href="{{ url_for('auth_bp.logout') }}" class="btn btn-outline-danger btn-sm">
                <i class="bi bi-box-arrow-right me-1"></i>Logout
              </a>
            </div>
          </div>
        </div>

        <!-- KPIs -->
        <div class="row g-3">
          <div class="col-6 col-xl-12">
            <div class="card text-center shadow-sm border-0 h-100">
              <div class="card-body py-3 small d-flex flex-column justify-content-center">
                <div class="text-body-secondary mb-1"><i class="bi bi-diagram-3"></i> Workspaces</div>
                <div class="fw-semibold fs-5">{{ total_workspaces }}</div>
              </div>
            </div>
          </div>
          <div class="col-6 col-xl-12">
            <div class="card text-center shadow-sm border-0 h-100">
              <div class="card-body py-3 small d-flex flex-column justify-content-center">
                <div class="text-body-secondary mb-1"><i class="bi bi-easel2"></i> Workshops</div>
                <div class="fw-semibold fs-5">{{ total_workshops }}</div>
              </div>
            </div>
          </div>
          <div class="col-6 col-xl-12">
            <div class="card text-center shadow-sm border-0 h-100">
              <div class="card-body py-3 small d-flex flex-column justify-content-center">
                <div class="text-body-secondary mb-1"><i class="bi bi-file-earmark-text"></i> Documents</div>
                <div class="fw-semibold fs-5">{{ total_documents }}</div>
              </div>
            </div>
          </div>
          <div class="col-6 col-xl-12">
            <div class="card text-center shadow-sm border-0 h-100">
              <div class="card-body py-3 small d-flex flex-column justify-content-center">
                <div class="text-body-secondary mb-1"><i class="bi bi-people"></i> Connections</div>
                <div class="fw-semibold fs-5">{{ total_members }}</div>
              </div>
            </div>
          </div>

          {% if pending_invitation_count > 0 %}
          <div class="col-12">
            <div class="alert alert-info py-2 mb-0 small" role="status">
              <i class="bi bi-envelope-open me-1"></i>
              {{ pending_invitation_count }} invitation{{ pending_invitation_count>1 and 's' or '' }} pending
            </div>
          </div>
          {% endif %}
        </div>
      </aside>

      <!-- RIGHT COLUMN: Main -->
      <section class="col-lg-8 col-xl-9">
        {% if my_workspaces|length == 0 %}
          <!-- Empty state -->
          <div class="card shadow-sm border-0">
            <div class="card-body text-center py-5">
              <div class="mb-3">
                <i class="bi bi-diagram-3 display-6 text-primary"></i>
              </div>
              <h2 class="h4 mb-2">Welcome to {{ app_name }}, {{ display_name }}!</h2>
              <p class="text-body-secondary mb-4">
                Create or join a workspace to start collaborating, scheduling workshops, and sharing documents.
              </p>
              <div class="d-flex justify-content-center gap-2">
                <a href="{{ url_for('workspace_bp.create_workspace') }}" class="btn btn-primary btn-lg">
                  <i class="bi bi-building-add me-1"></i>Create Workspace
                </a>
                <a href="{{ url_for('workspace_bp.list_workspaces') }}" class="btn btn-outline-secondary btn-lg">
                  <i class="bi bi-search me-1"></i>Browse Workspaces
                </a>
              </div>
            </div>
          </div>
        {% else %}

          <!-- Quick tabs (optional) -->
          <ul class="nav nav-pills mb-3" id="acctTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="tab-overview" data-bs-toggle="pill" data-bs-target="#pane-overview" type="button" role="tab" aria-controls="pane-overview" aria-selected="true">
                <i class="bi bi-speedometer2 me-1"></i>Overview
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="tab-workshops" data-bs-toggle="pill" data-bs-target="#pane-workshops" type="button" role="tab" aria-controls="pane-workshops" aria-selected="false">
                <i class="bi bi-calendar2-check me-1"></i>Workshops
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="tab-docs" data-bs-toggle="pill" data-bs-target="#pane-docs" type="button" role="tab" aria-controls="pane-docs" aria-selected="false">
                <i class="bi bi-files me-1"></i>Documents
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="tab-people" data-bs-toggle="pill" data-bs-target="#pane-people" type="button" role="tab" aria-controls="pane-people" aria-selected="false">
                <i class="bi bi-people me-1"></i>Network
              </button>
            </li>
          </ul>

          <div class="tab-content" id="acctTabsContent">
            <!-- OVERVIEW -->
            <div class="tab-pane fade show active" id="pane-overview" role="tabpanel" aria-labelledby="tab-overview">
              <!-- Workspaces -->
              <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-transparent py-3 d-flex justify-content-between align-items-center">
                  <span class="fw-semibold d-inline-flex align-items-center gap-2"><i class="bi bi-diagram-3 text-primary"></i>My Workspaces</span>
                  <div class="d-flex align-items-center gap-2">
                    <a href="{{ url_for('workspace_bp.create_workspace') }}" class="btn btn-sm btn-primary">
                      <i class="bi bi-plus-circle me-1"></i>New
                    </a>
                  </div>
                </div>
                <div class="list-group list-group-flush small">
                  {% for workspace in my_workspaces %}
                    <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-start gap-3"
                       href="{{ url_for('workspace_bp.view_workspace', workspace_id=workspace.workspace_id) }}">
                      <div class="flex-grow-1">
                        <div class="fw-semibold text-truncate" title="{{ workspace.name }}"><i class="bi bi-diagram-3 me-1"></i>{{ workspace.name }}</div>
                        <div class="text-body-secondary small d-flex flex-wrap gap-2 align-items-center">
                          <span class="badge text-bg-{{ 'secondary' if workspace.is_private else 'info text-dark' }}">{{ 'Private' if workspace.is_private else 'Public' }}</span>
                        </div>
                      </div>
                      <i class="bi bi-chevron-right text-body-tertiary"></i>
                    </a>
                  {% else %}
                    <div class="list-group-item text-body-secondary text-center">No workspaces found.</div>
                  {% endfor %}
                </div>
              </div>

              <!-- Upcoming Workshops & Recent Documents -->
              <div class="row g-4">
                <div class="col-xl-6">
                  <div class="card shadow-sm border-0 h-100">
                    <div class="card-header bg-transparent py-3 d-flex justify-content-between align-items-center">
                      <span class="fw-semibold d-inline-flex align-items-center gap-2"><i class="bi bi-calendar-event text-primary"></i>Upcoming Workshops</span>
                      <a href="{{ url_for('workshop_bp.create_workshop_general') }}"
                         class="btn btn-sm btn-outline-primary" title="Create Workshop" aria-label="Create Workshop">
                        <i class="bi bi-calendar-plus"></i>
                      </a>
                    </div>
                    <div class="list-group list-group-flush small">
                      {% for ws in upcoming_workshops %}
                        <div class="list-group-item d-flex justify-content-between align-items-start gap-3">
                          <div class="flex-grow-1">
                            <div class="fw-semibold text-truncate" title="{{ ws.title }}"><i class="bi bi-easel2 me-1"></i>{{ ws.title }}</div>
                            <div class="text-body-secondary small">{{ ws.date_time.strftime('%Y-%m-%d %H:%M') }}</div>
                          </div>
                          <a href="{{ url_for('workshop_bp.view_workshop', workshop_id=ws.id) }}" class="btn btn-sm btn-outline-secondary">Open</a>
                        </div>
                      {% else %}
                        <div class="list-group-item text-body-secondary text-center">No upcoming workshops.</div>
                      {% endfor %}
                    </div>
                  </div>
                </div>

                <div class="col-xl-6">
                  <div class="card shadow-sm border-0 h-100">
                    <div class="card-header bg-transparent py-3 d-flex justify-content-between align-items-center">
                      <span class="fw-semibold d-inline-flex align-items-center gap-2"><i class="bi bi-files text-primary"></i>Recent Documents</span>
                      <a href="{{ url_for('document_bp.list_documents') }}"
                         class="btn btn-sm btn-outline-primary" title="All Documents" aria-label="All Documents">
                        <i class="bi bi-folder2-open"></i>
                      </a>
                    </div>
                    <div class="list-group list-group-flush small">
                      {% for doc in recent_documents %}
                        <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-start gap-3" href="{{ url_for('document_bp.preview_document', document_id=doc.id) }}">
                          <div class="flex-grow-1">
                            <div class="fw-semibold text-truncate" title="{{ doc.title }}"><i class="bi bi-file-earmark-text me-1"></i>{{ doc.title }}</div>
                            <div class="text-body-secondary small">{{ doc.workspace.name }} • {{ doc.uploaded_at.strftime('%Y-%m-%d') }}</div>
                          </div>
                          <i class="bi bi-chevron-right text-body-tertiary"></i>
                        </a>
                      {% else %}
                        <div class="list-group-item text-body-secondary text-center">No documents yet.</div>
                      {% endfor %}
                    </div>
                  </div>
                </div>
              </div>

              <!-- Past Workshops & People -->
              <div class="row g-4 mt-1">
                <div class="col-xl-6">
                  <div class="card shadow-sm border-0 h-100">
                    <div class="card-header bg-transparent py-3 fw-semibold d-inline-flex align-items-center gap-2">
                      <i class="bi bi-archive text-primary"></i><span>Recent Participation</span>
                    </div>
                    <div class="list-group list-group-flush small">
                      {% for ws in past_workshops %}
                        <div class="list-group-item d-flex justify-content-between align-items-start gap-3">
                          <div class="flex-grow-1">
                            <div class="fw-semibold text-truncate" title="{{ ws.title }}"><i class="bi bi-easel2 me-1"></i>{{ ws.title }}</div>
                            <div class="text-body-secondary small">{{ ws.date_time.strftime('%Y-%m-%d %H:%M') }}</div>
                          </div>
                          <a href="{{ url_for('workshop_bp.view_workshop', workshop_id=ws.id) }}" class="btn btn-sm btn-outline-secondary">View</a>
                        </div>
                      {% else %}
                        <div class="list-group-item text-body-secondary text-center">No past workshops yet.</div>
                      {% endfor %}
                    </div>
                  </div>
                </div>

                <div class="col-xl-6">
                  <div class="card shadow-sm border-0 h-100">
                    <div class="card-header bg-transparent py-3 fw-semibold d-inline-flex align-items-center gap-2">
                      <i class="bi bi-people text-primary"></i><span>New Collaborators</span>
                    </div>
                    <div class="list-group list-group-flush small">
                      {% for m in recent_collaborators %}
                        {% set u = m.user %}
                        <a class="list-group-item list-group-item-action d-flex align-items-center gap-2" href="{{ url_for('account_bp.public_profile', user_id=u.user_id) }}">
                          <span class="avatar-circle d-inline-block overflow-hidden avatar-40"><img src="{{ profile_url(u.profile_pic_url) }}" class="avatar-img" alt="{{ u.first_name or 'User' }}" /></span>
                          <div class="flex-grow-1">
                            <div class="fw-semibold text-truncate">{{ u.first_name }} {{ u.last_name }}</div>
                            <div class="text-body-secondary small">Joined {{ (m.joined_timestamp or m.created_timestamp).strftime('%Y-%m-%d') if m.joined_timestamp or m.created_timestamp else '' }}</div>
                          </div>
                          <span class="badge text-bg-light text-wrap">{{ m.workspace_id }}</span>
                        </a>
                      {% else %}
                        <div class="list-group-item text-body-secondary text-center">No other members yet.</div>
                      {% endfor %}
                    </div>
                  </div>
                </div>

                {% if pending_requests %}
                <div class="col-xl-6">
                  <div class="card shadow-sm border-0 h-100">
                    <div class="card-header bg-transparent py-3 fw-semibold d-inline-flex align-items-center gap-2">
                      <i class="bi bi-person-plus text-warning"></i><span>Pending Member Requests</span>
                    </div>
                    <div class="list-group list-group-flush small">
                      {% for req in pending_requests %}
                        {% set u = req.user %}
                        <div class="list-group-item d-flex align-items-center gap-2">
                          <span class="avatar-circle d-inline-block overflow-hidden avatar-40"><img src="{{ profile_url(u.profile_pic_url) }}" class="avatar-img" alt="{{ u.first_name or 'User' }}"></span>
                          <div class="flex-grow-1">
                            <div class="">
                              <a href="{{ url_for('account_bp.public_profile', user_id=u.user_id) }}" class="fw-semibold text-truncate d-inline-block text-decoration-none">
                                {{ u.first_name }} {{ u.last_name }}
                              </a>
                            </div>
                            <div class="text-body-secondary small"> {{ (req.workspace.name if req.workspace and req.workspace.name else 'Workspace #' ~ req.workspace_id) }} • {{ (req.joined_timestamp or req.created_timestamp).strftime('%Y-%m-%d') if req.joined_timestamp or req.created_timestamp else '' }}</div>
                          </div>
                          <form method="POST" action="{{ url_for('workspace_bp.approve_member', workspace_id=req.workspace_id, member_id=req.id) }}" class="d-inline">
                            <button type="submit" class="btn btn-success btn-sm" title="Approve" aria-label="Approve"><i class="bi bi-check"></i></button>
                          </form>
                          <form method="POST" action="{{ url_for('workspace_bp.reject_member', workspace_id=req.workspace_id, member_id=req.id) }}" class="d-inline ms-1">
                            <button type="submit" class="btn btn-outline-danger btn-sm" title="Reject" aria-label="Reject"><i class="bi bi-x"></i></button>
                          </form>
                        </div>
                      {% endfor %}
                    </div>
                  </div>
                </div>
                {% endif %}
              </div>

              {% if pending_invitations %}
                <div class="card shadow-sm border-0 mt-4">
                  <div class="card-header bg-transparent py-3 fw-semibold d-inline-flex align-items-center gap-2">
                    <i class="bi bi-envelope-open text-primary"></i><span>Pending Invitations</span>
                  </div>
          <div class="list-group list-group-flush small">
                    {% for inv in pending_invitations %}
            <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div class="me-3">
                          <div class="fw-semibold">{{ inv.workspace.name }}</div>
                          <div class="text-body-secondary">Sent {{ inv.sent_timestamp.strftime('%Y-%m-%d') }}</div>
                        </div>
                        <div class="btn-group btn-group-sm" role="group" aria-label="Invitation actions">
                          <a href="{{ url_for('workspace_bp.respond_invitation', invitation_id=inv.id, action='accept') }}" class="btn btn-success" title="Accept" aria-label="Accept invitation">
                            <i class="bi bi-check-lg"></i>
                          </a>
                          <a href="{{ url_for('workspace_bp.respond_invitation', invitation_id=inv.id, action='decline') }}" class="btn btn-outline-danger" title="Decline" aria-label="Decline invitation">
                            <i class="bi bi-x-lg"></i>
                          </a>
                        </div>
            </div>
                    {% endfor %}
          </div>
                </div>
              {% endif %}
            </div>

            <!-- WORKSHOPS -->
            <div class="tab-pane fade" id="pane-workshops" role="tabpanel" aria-labelledby="tab-workshops">
              <div class="card shadow-sm border-0">
                <div class="card-header bg-transparent py-3 d-flex justify-content-between align-items-center">
                  <span class="fw-semibold d-inline-flex align-items-center gap-2"><i class="bi bi-calendar3 text-primary"></i>All Workshops</span>
                  <a href="{{ url_for('workshop_bp.create_workshop_general') }}" class="btn btn-sm btn-primary">
                    <i class="bi bi-plus-circle me-1"></i>New
                  </a>
                </div>
                <div class="list-group list-group-flush small">
                  {% for ws in upcoming_workshops + past_workshops %}
                    <div class="list-group-item d-flex justify-content-between align-items-start gap-3">
                      <div class="flex-grow-1">
                        <div class="fw-semibold text-truncate" title="{{ ws.title }}"><i class="bi bi-easel2 me-1"></i>{{ ws.title }}</div>
                        <div class="text-body-secondary small">{{ ws.date_time.strftime('%Y-%m-%d %H:%M') }}</div>
                      </div>
                      <a href="{{ url_for('workshop_bp.view_workshop', workshop_id=ws.id) }}" class="btn btn-sm btn-outline-secondary">Open</a>
                    </div>
                  {% else %}
                    <div class="list-group-item text-body-secondary text-center">No workshops to show.</div>
                  {% endfor %}
                </div>
              </div>
            </div>

            <!-- DOCUMENTS -->
            <div class="tab-pane fade" id="pane-docs" role="tabpanel" aria-labelledby="tab-docs">
              <div class="card shadow-sm border-0">
                <div class="card-header bg-transparent py-3 d-flex justify-content-between align-items-center">
                  <span class="fw-semibold d-inline-flex align-items-center gap-2"><i class="bi bi-folder2-open text-primary"></i>All Documents</span>
                  <a href="{{ url_for('document_bp.list_documents') }}" class="btn btn-sm btn-outline-primary">Open Library</a>
                </div>
                <div class="list-group list-group-flush small">
                  {% for doc in recent_documents %}
                    <div class="list-group-item d-flex justify-content-between align-items-start gap-3">
                      <div class="flex-grow-1">
                        <div class="fw-semibold text-truncate" title="{{ doc.title }}"><i class="bi bi-file-earmark-text me-1"></i>{{ doc.title }}</div>
                        <div class="text-body-secondary small">{{ doc.workspace.name }} • {{ doc.uploaded_at.strftime('%Y-%m-%d') }}</div>
                      </div>
                    </div>
                  {% else %}
                    <div class="list-group-item text-body-secondary text-center">No documents yet.</div>
                  {% endfor %}
                </div>
              </div>
            </div>

            <!-- PEOPLE -->
            <div class="tab-pane fade" id="pane-people" role="tabpanel" aria-labelledby="tab-people">
              <div class="card shadow-sm border-0">
                <div class="card-header bg-transparent py-3 fw-semibold d-inline-flex align-items-center gap-2">
                  <i class="bi bi-people text-primary"></i><span>People</span>
                </div>
                <div class="list-group list-group-flush small">
                  {% for member in members %}
                    <a class="list-group-item list-group-item-action d-flex align-items-center gap-2" href="{{ url_for('account_bp.public_profile', user_id=member.user_id) }}">
                      <span class="avatar-circle d-inline-block overflow-hidden avatar-40"><img src="{{ profile_url(member.profile_pic_url) }}" class="avatar-img" alt="{{ member.first_name }}" /></span>
                      <div class="flex-grow-1">
                        <div class="fw-semibold text-truncate">{{ member.first_name }} {{ member.last_name }}</div>
                        <div class="text-body-secondary">{{ member.organization or member.job_title }}</div>
                      </div>
                      <i class="bi bi-chevron-right text-body-tertiary"></i>
                    </a>
                  {% else %}
                    <div class="list-group-item text-body-secondary text-center">No members yet.</div>
                  {% endfor %}
                </div>
              </div>
            </div>
          </div>
        {% endif %}
      </section>
    </div>
  </div>
</section>

{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    // Persist/restore active tab (wait for Bootstrap to be available)
    (function initAcctTabs(){
      function run(){
        const tabs = document.getElementById('acctTabs');
        if (!tabs) return;
        const key = 'acct.activeTab';
        const saved = localStorage.getItem(key);
        try {
          if (saved && window.bootstrap && window.bootstrap.Tab) {
            const trigger = document.querySelector(`[data-bs-target="${saved}"]`);
            if (trigger) new bootstrap.Tab(trigger).show();
          }
        } catch(e) { /* ignore */ }
        tabs.addEventListener('shown.bs.tab', function (e) {
          const pane = e.target.getAttribute('data-bs-target');
          localStorage.setItem(key, pane);
        });
      }
      if (document.readyState === 'loading'){
        document.addEventListener('DOMContentLoaded', run);
      } else { run(); }
    })();
  </script>
{% endblock %}
<!-- End of app/account/templates/account_details.html -->

