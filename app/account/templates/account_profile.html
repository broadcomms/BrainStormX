{% extends 'main_template.html' %}
{% block title %}User: {{ (profile_user.first_name ~ ' ' ~ profile_user.last_name)|trim or profile_user.username or profile_user.email }}{% endblock %}

{% block content %}
<section class="py-4 bg-body-tertiary">
	<div class="container">
		<!-- Header + Breadcrumbs -->
		<div class="d-flex flex-wrap justify-content-between align-items-start mb-4">
			<div class="me-2">
				<h1 class="h4 fw-bold mb-1 d-flex align-items-center gap-2">
					<i class="bi bi-person-circle"></i>
					  <span class="text-truncate mw-50ch" title="{{ profile_user.first_name or '' }} {{ profile_user.last_name or '' }}">
						{% if profile_user.first_name or profile_user.last_name %}
							{{ profile_user.first_name or '' }} {{ profile_user.last_name or '' }}
						{% elif profile_user.username %}
							{{ profile_user.username }}
						{% else %}
							{{ profile_user.email.split('@')[0] }}
						{% endif %}
					</span>
					{% if profile_user.job_title %}<span class="badge text-bg-light text-wrap small">{{ profile_user.job_title }}</span>{% endif %}
				</h1>
				<nav aria-label="breadcrumb">
					<ol class="breadcrumb mb-0 small">
						<li class="breadcrumb-item"><a href="{{ url_for('main_bp.index') }}">Home</a></li>
						<li class="breadcrumb-item active" aria-current="page">User Profile</li>
					</ol>
				</nav>
					</div>
		            <div class="ms-auto">
			{% if can_invite %}
			<div class="d-flex gap-2 mt-3 mt-sm-0 align-items-center">
				{% if invite_workspaces|length > 0 %}
				<button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#inviteWorkspaceModal">
					<i class="bi bi-person-plus"></i> Invite to Workspace
				</button>
				{% endif %}
				<button type="button" class="btn btn-outline-success btn-sm" data-bs-toggle="modal" data-bs-target="#inviteWorkshopModal">
					<i class="bi bi-calendar-plus"></i> Invite to Workshop
				</button>
			</div>
			{% endif %}
					</div>
				</div>

		<!-- Summary / Hero Card -->
		<div class="card shadow-sm border-0 mb-4">
			<div class="card-body d-flex flex-column flex-md-row gap-4 align-items-start">
						<div class="text-center avatar-xl-wrapper">
					<span class="avatar-circle avatar-xl d-inline-block overflow-hidden border bg-white shadow-sm mx-auto">
						<img src="{{ profile_url(profile_user.profile_pic_url) }}" alt="Profile picture of {{ profile_user.first_name or profile_user.username or profile_user.email }}" class="avatar-img">
					</span>
				</div>
				<div class="flex-grow-1">
					<div class="d-flex flex-wrap align-items-center gap-2 mb-2">
						<span class="fw-semibold">{{ profile_user.first_name or '' }} {{ profile_user.last_name or '' }}</span>
						{% if profile_user.username %}<span class="badge text-bg-primary">@{{ profile_user.username }}</span>{% endif %}
						{% if profile_user.organization %}<span class="badge text-bg-secondary d-inline-flex align-items-center gap-1"><i class="bi bi-building"></i>{{ profile_user.organization }}</span>{% endif %}
					</div>
														<div class="table-responsive">
															<table class="table table-sm mb-0 align-middle small">
																<tbody>
																	<tr>
																		<th scope="row" class="fw-semibold text-body-secondary">Email</th>
																		<td>
																			<a href="mailto:{{ profile_user.email }}" class="text-decoration-none">{{ profile_user.email }}</a>
																			{% if profile_user.email_verified %}<span class="badge text-bg-success ms-2"><i class="bi bi-shield-check"></i> Verified</span>{% endif %}
																		</td>
																	</tr>
																	{% if profile_user.phone_number %}
																	<tr>
																		<th scope="row" class="fw-semibold text-body-secondary">Phone</th>
																		<td>{{ profile_user.phone_number }}</td>
																	</tr>
																	{% endif %}
																	{% if profile_user.job_title %}
																	<tr>
																		<th scope="row" class="fw-semibold text-body-secondary">Title</th>
																		<td>{{ profile_user.job_title }}</td>
																	</tr>
																	{% endif %}
																	<tr>
																		<th scope="row" class="fw-semibold text-body-secondary">Joined</th>
																		<td>{{ profile_user.created_timestamp.strftime('%Y-%m-%d') if profile_user.created_timestamp else '—' }}</td>
																	</tr>
																	<tr>
																		<th scope="row" class="fw-semibold text-body-secondary">Last Update</th>
																		<td>{{ profile_user.updated_timestamp.strftime('%Y-%m-%d') if profile_user.updated_timestamp else '—' }}</td>
																	</tr>
																</tbody>
															</table>
														</div>
				</div>
						<div class="ms-md-auto w-md-auto minw-stats">
							<div class="row g-2 text-center small">
						<div class="col-6 col-md-12">
							<div class="border rounded p-2 h-100">
								<div class="text-body-secondary"><i class="bi bi-diagram-3"></i> Workspaces</div>
								<div class="fw-bold fs-5">{{ stats.workspaces }}</div>
							</div>
						</div>
						<div class="col-6 col-md-12">
							<div class="border rounded p-2 h-100">
								<div class="text-body-secondary"><i class="bi bi-file-earmark-text"></i> Documents</div>
								<div class="fw-bold fs-5">{{ stats.documents }}</div>
							</div>
						</div>
						<div class="col-6 col-md-12">
							<div class="border rounded p-2 h-100">
								<div class="text-body-secondary"><i class="bi bi-easel2"></i> Created</div>
								<div class="fw-bold fs-5">{{ stats.workshops_created }}</div>
							</div>
						</div>
						<div class="col-6 col-md-12">
							<div class="border rounded p-2 h-100">
								<div class="text-body-secondary"><i class="bi bi-people"></i> Participated</div>
								<div class="fw-bold fs-5">{{ stats.workshops_participated }}</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

		<div class="row g-4">
			<!-- Left/Main Column -->
			<div class="col-lg-8 d-flex flex-column gap-4">
				<!-- Active Workspaces -->
				<div class="card shadow-sm border-0">
					<div class="card-header bg-transparent py-3 d-flex align-items-center gap-2">
						<i class="bi bi-diagram-3 text-primary"></i>
						<span class="fw-semibold">Workspaces ({{ active_workspaces|length }})</span>
					</div>
						<div class="list-group list-group-flush small">
							{% if active_workspaces %}
								{% for ws in active_workspaces %}
									<a href="{{ url_for('workspace_bp.view_workspace', workspace_id=ws.workspace_id) }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-start gap-3">
										<div class="flex-grow-1">
											<div class="fw-semibold text-truncate" title="{{ ws.name }}"><i class="bi bi-diagram-3 me-1"></i>{{ ws.name }}</div>
											{% if ws.description %}
												<div class="text-body-secondary text-truncate mw-60ch">{{ ws.description|striptags|truncate(90) }}</div>
											{% endif %}
											<div class="text-body-secondary small d-flex flex-wrap gap-2 align-items-center mt-1">
												<span><i class="bi bi-calendar-plus me-1"></i>{{ ws.created_timestamp.strftime('%Y-%m-%d') if ws.created_timestamp else '—' }}</span>
												<span class="badge text-bg-{{ 'secondary' if ws.is_private else 'info text-dark' }}">{{ 'Private' if ws.is_private else 'Public' }}</span>
											</div>
										</div>
										{% set role = (memberships|selectattr('workspace_id','equalto',ws.workspace_id)|first).role %}
										<span class="badge text-bg-light">{{ role|capitalize }}</span>
									</a>
								{% endfor %}
							{% else %}
								<div class="p-4 text-center text-body-secondary">No active workspace memberships.</div>
							{% endif %}
						</div>
				</div>

				<!-- Recent Document Uploads -->
				<div class="card shadow-sm border-0">
					<div class="card-header bg-transparent py-3 d-flex align-items-center gap-2">
						<i class="bi bi-file-earmark-text text-primary"></i>
						<span class="fw-semibold">Recent Documents ({{ recent_documents|length }})</span>
					</div>
					<div class="list-group list-group-flush small">
						{% if recent_documents %}
							{% for d in recent_documents %}
							<a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" href="#">
								<span class="text-truncate">{{ d.title }}</span>
								<small class="text-body-secondary">{{ d.uploaded_at.strftime('%Y-%m-%d') if d.uploaded_at }}</small>
							</a>
							{% endfor %}
						{% else %}
							<div class="p-4 text-center text-body-secondary">No recent uploads.</div>
						{% endif %}
					</div>
				</div>

				<!-- Workshops Created -->
				<div class="card shadow-sm border-0">
					<div class="card-header bg-transparent py-3 d-flex align-items-center gap-2">
						<i class="bi bi-easel2 text-primary"></i>
						<span class="fw-semibold">Created Workshops ({{ recent_created_workshops|length }})</span>
					</div>
					<div class="list-group list-group-flush small">
						{% if recent_created_workshops %}
							{% for ws in recent_created_workshops %}
							<a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" href="{{ url_for('workshop_bp.view_workshop', workshop_id=ws.id) if ws.id }}">
								<span class="text-truncate">{{ ws.title }}</span>
								<small class="text-body-secondary">{{ ws.date_time.strftime('%Y-%m-%d') if ws.date_time }}</small>
							</a>
							{% endfor %}
						{% else %}
							<div class="p-4 text-center text-body-secondary">No workshops created.</div>
						{% endif %}
					</div>
				</div>
			</div>

			<!-- Side Column -->
			<div class="col-lg-4 d-flex flex-column gap-4">
				<!-- Participation -->
				<div class="card shadow-sm border-0">
					<div class="card-header bg-transparent py-3 d-flex align-items-center gap-2">
						<i class="bi bi-people text-primary"></i>
						<span class="fw-semibold">Recent Participation ({{ recent_participations|length }})</span>
					</div>
					<div class="list-group list-group-flush small">
						{% if recent_participations %}
							{% for p in recent_participations %}
							<div class="list-group-item d-flex justify-content-between align-items-center">
								<span class="text-truncate">Workshop #{{ p.workshop_id }}</span>
								<small class="text-body-secondary">{{ p.joined_timestamp.strftime('%Y-%m-%d') if p.joined_timestamp }}</small>
							</div>
							{% endfor %}
						{% else %}
							<div class="p-4 text-center text-body-secondary">No workshop participation yet.</div>
						{% endif %}
					</div>
				</div>

				<!-- Contact / Meta -->
				<div class="card shadow-sm border-0">
					<div class="card-header bg-transparent py-3 d-flex align-items-center gap-2">
						<i class="bi bi-info-circle text-primary"></i>
						<span class="fw-semibold">Profile Meta</span>
					</div>
					<div class="card-body small">
						<ul class="list-unstyled mb-0 d-flex flex-column gap-2">
							<li class="d-flex align-items-start gap-2"><i class="bi bi-calendar3 text-body-secondary"></i><span><strong>Account Created:</strong> {{ profile_user.created_timestamp.strftime('%Y-%m-%d %H:%M') if profile_user.created_timestamp else '—' }}</span></li>
							<li class="d-flex align-items-start gap-2"><i class="bi bi-shield-lock text-body-secondary"></i><span><strong>Email Verified:</strong> {{ 'Yes' if profile_user.email_verified else 'No' }}</span></li>
							<li class="d-flex align-items-start gap-2"><i class="bi bi-person-badge text-body-secondary"></i><span><strong>System Role:</strong> {{ profile_user.role|capitalize }}</span></li>
						</ul>
						<div class="mt-3 text-body-secondary">Only workspace members can see this information.</div>
					</div>
				</div>

				<!-- Guidance / Help -->
				<div class="card shadow-sm border-0">
					<div class="card-header bg-transparent py-3 d-flex align-items-center gap-2">
						<i class="bi bi-lightbulb text-warning"></i>
						<span class="fw-semibold">Tips</span>
					</div>
					<div class="card-body small">
						<ul class="list-unstyled mb-0 d-flex flex-column gap-2">
							<li class="d-flex gap-2"><i class="bi bi-pencil-square text-body-secondary"></i><span>Encourage users to complete their profile for better collaboration.</span></li>
							<li class="d-flex gap-2"><i class="bi bi-people text-body-secondary"></i><span>Workspace roles help set expectations in workshops.</span></li>
							<li class="d-flex gap-2"><i class="bi bi-file-earmark-text text-body-secondary"></i><span>Document contributions build trust in shared spaces.</span></li>
						</ul>
					</div>
				</div>
			</div>
		</div>
	</div>
{% if can_invite %}
<!-- Modals: keep within content so they render -->
<!-- Invite to Workspace Modal -->
<div class="modal fade" id="inviteWorkspaceModal" tabindex="-1" aria-labelledby="inviteWorkspaceLabel" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered">
		<form action="{{ url_for('workspace_bp.invite_member') }}" method="post" class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title d-flex align-items-center gap-2" id="inviteWorkspaceLabel"><i class="bi bi-person-plus text-primary"></i><span>Invite to Workspace</span></h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body small">
				<input type="hidden" name="email" id="inviteWorkspaceEmail" value="{{ profile_user.email }}" />
				<div class="mb-3">
					<label for="workspaceSelect" class="form-label fw-semibold">Select Workspace</label>
					<select id="workspaceSelect" name="workspace_id" class="form-select" required>
						<option value="" selected disabled>Choose...</option>
						{% for w in invite_workspaces %}
						<option value="{{ w.workspace_id }}">{{ w.name }}</option>
						{% endfor %}
					</select>
					<div class="form-text">Only your workspaces where you are admin/manager are listed.</div>
				</div>
				<div class="mb-3">
					<label for="workspaceInviteMessage" class="form-label fw-semibold">Message (optional)</label>
					<textarea id="workspaceInviteMessage" name="custom_message" rows="3" class="form-control" placeholder="Add a short welcome or context..."></textarea>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
				<button type="submit" class="btn btn-primary"><i class="bi bi-send me-1"></i>Send Invite</button>
			</div>
		</form>
	</div>
</div>

<!-- Invite to Workshop Modal -->
<div class="modal fade" id="inviteWorkshopModal" tabindex="-1" aria-labelledby="inviteWorkshopLabel" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered">
		<form action="{{ url_for('workshop_bp.add_participant', workshop_id=0) }}" method="post" class="modal-content" onsubmit="return false;">
			<div class="modal-header">
				<h5 class="modal-title d-flex align-items-center gap-2" id="inviteWorkshopLabel"><i class="bi bi-calendar-plus text-success"></i><span>Invite to Workshop</span></h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body small">
				<input type="hidden" name="user_id" value="{{ profile_user.user_id }}" />
				<div class="mb-3">
					<label for="workshopSelect" class="form-label fw-semibold">Select Workshop (you organize)</label>
					<select id="workshopSelect" class="form-select" required>
						<option value="" selected disabled>Choose...</option>
						{% for ws in organizer_workshops %}
						<option value="{{ ws.id }}">{{ ws.title }}{% if ws.date_time %} — {{ ws.date_time.strftime('%Y-%m-%d %H:%M') }}{% endif %}</option>
						{% endfor %}
					</select>
					<div class="form-text">Only workshops you organize are listed.</div>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
				<button type="button" class="btn btn-success" id="sendWorkshopInviteBtn"><i class="bi bi-send me-1"></i>Send Invite</button>
			</div>
		</form>
	</div>
</div>
{% endif %}

</section>
{% endblock %}

{% block scripts %}
	{{ super() }}
	{% if can_invite %}
	<script>
	(function(){
	  // Workspace invite: no JS needed besides default value prefill

	  const btn = document.getElementById('sendWorkshopInviteBtn');
	  btn?.addEventListener('click', async function(){
	    const select = document.getElementById('workshopSelect');
	    const workshopId = select?.value;
	    if(!workshopId){ select?.focus(); return; }
	    const formData = new FormData();
	    formData.append('user_id', '{{ profile_user.user_id }}');
	    const resp = await fetch(`{{ url_for('workshop_bp.add_participant', workshop_id=0) }}`.replace('/0/','/'+workshopId+'/'), {
	      method: 'POST',
	      credentials: 'same-origin',
	      body: formData
	    });
	    if(resp.redirected){ window.location.href = resp.url; }
	    else { location.reload(); }
	  });
	})();
	</script>
	{% endif %}
{% endblock %}
